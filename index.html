<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tr√≤ ch∆°i gh√©p h√¨nh tr√°i tim üíñ</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #fafafa;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    h1 {
      margin-bottom: 10px;
    }

    .board {
      position: relative;
      width: 600px;
      height: 600px;
      border: 3px solid #ccc;
      border-radius: 16px;
      background: #fff;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      overflow: hidden;
      background-image: url("puzzle.png");
      background-size: cover;
      background-position: center;
      transition: opacity 0.3s;
    }

    .slot {
      position: absolute;
      border: 2px dashed transparent;
      transition: border-color 0.2s;
    }

    .slot.correct {
      border-color: #22c55e;
    }

    .tray {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
      justify-content: center;
      max-width: 640px;
    }

    .piece {
      width: 130px;
      height: 130px;
      object-fit: contain;
      cursor: grab;
      user-select: none;
      transition: transform 0.1s;
    }

    .piece:active {
      transform: scale(1.1);
      cursor: grabbing;
    }

    button {
      margin: 8px;
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      color: white;
      background: #3b82f6;
    }

    button.secondary { background: #64748b; }

    .ghost {
      position: fixed;
      pointer-events: none;
      z-index: 1000;
      width: 130px;
      height: 130px;
      object-fit: contain;
      opacity: 0.9;
      transform: scale(1.1);
    }

    @media (max-width:700px){
      .board{width:90vw;height:90vw;}
      .piece{width:22vw;height:22vw;}
    }
  </style>
</head>
<body>
  <h1>üß© Gh√©p h√¨nh tr√°i tim üíñ</h1>
  <div class="board" id="board"></div>

  <div class="tray" id="tray"></div>

  <div>
    <button id="shuffle">X√°o tr·ªôn</button>
    <button id="reset" class="secondary">ƒê·∫∑t l·∫°i</button>
    <button id="toggle" class="secondary">Hi·ªán / ·∫©n ·∫£nh g·ªëc</button>
  </div>

  <script>
    const BOARD_SIZE = 600;
    const COLS = 4;
    const ROWS = 4;
    const W = 1 / COLS;
    const H = 1 / ROWS;

    const BG = "puzzle.png";
    const PIECES = Array.from({ length: 14 }, (_, i) => `p${i + 1}.png`);

    // X√°c ƒë·ªãnh v·ªã tr√≠ m·∫£nh tr√™n l∆∞·ªõi 4x4 (b·ªè 2 √¥ tr·ªëng tr√™n c√πng gi·ªØa tim)
    const TARGETS = [
      {x:0, y:0, w:W, h:H},       // p1
      {x:0, y:H, w:W, h:H},       // p2
      {x:0, y:2*H, w:W, h:H},     // p3
      {x:W, y:0, w:W, h:H},       // p4
      {x:W, y:H, w:W, h:H},       // p5
      {x:W, y:2*H, w:W, h:H},     // p6
      {x:W, y:3*H, w:W, h:H},     // p7
      {x:2*W, y:0, w:W, h:H},     // p8
      {x:2*W, y:H, w:W, h:H},     // p9
      {x:2*W, y:2*H, w:W, h:H},   // p10
      {x:2*W, y:3*H, w:W, h:H},   // p11
      {x:3*W, y:0, w:W, h:H},     // p12
      {x:3*W, y:H, w:W, h:H},     // p13
      {x:3*W, y:2*H, w:W, h:H},   // p14
    ];

    const board = document.getElementById("board");
    const tray = document.getElementById("tray");

    // T·∫°o c√°c slot v·ªã tr√≠ ƒë√≠ch
    const slots = TARGETS.map((t, i) => {
      const div = document.createElement("div");
      div.className = "slot";
      div.dataset.index = i;
      Object.assign(div.style, {
        left: `${t.x * 100}%`,
        top: `${t.y * 100}%`,
        width: `${t.w * 100}%`,
        height: `${t.h * 100}%`
      });
      board.appendChild(div);
      return div;
    });

    // T·∫°o m·∫£nh trong khay
    let pieces = [];
    function createPieces() {
      tray.innerHTML = "";
      pieces = PIECES.map((src, i) => {
        const img = document.createElement("img");
        img.src = src;
        img.className = "piece";
        img.dataset.index = i;
        tray.appendChild(img);
        makeDraggable(img);
        return img;
      });
    }

    // Drag-drop
    let dragging = null;
    let ghost = null;
    let offset = {x:0, y:0};

    function makeDraggable(img){
      img.addEventListener("pointerdown", e => {
        e.preventDefault();
        dragging = img;
        const r = img.getBoundingClientRect();
        offset.x = e.clientX - r.left;
        offset.y = e.clientY - r.top;
        ghost = img.cloneNode();
        ghost.className = "ghost";
        document.body.appendChild(ghost);
        moveGhost(e);
        window.addEventListener("pointermove", moveGhost);
        window.addEventListener("pointerup", dropPiece);
      });
    }

    function moveGhost(e){
      if(!ghost) return;
      ghost.style.left = e.clientX - offset.x + "px";
      ghost.style.top = e.clientY - offset.y + "px";
    }

    function dropPiece(e){
      if(!dragging) return;
      const rectBoard = board.getBoundingClientRect();
      const x = e.clientX - rectBoard.left;
      const y = e.clientY - rectBoard.top;

      // t√¨m slot g·∫ßn nh·∫•t
      let best = null;
      let minDist = Infinity;
      slots.forEach((s, i)=>{
        const r = s.getBoundingClientRect();
        const cx = r.left + r.width/2;
        const cy = r.top + r.height/2;
        const d = Math.hypot(e.clientX - cx, e.clientY - cy);
        if(d < minDist){ minDist = d; best = {slot:s, i}; }
      });

      const threshold = 60;
      if(best && minDist < threshold && !best.slot.dataset.filled){
        // g·∫Øn v√†o board
        placePiece(dragging, best.slot, best.i);
      }

      ghost.remove();
      ghost = null;
      dragging = null;
      window.removeEventListener("pointermove", moveGhost);
      window.removeEventListener("pointerup", dropPiece);
    }

    function placePiece(img, slot, index){
      slot.dataset.filled = "1";
      const piece = document.createElement("img");
      piece.src = img.src;
      piece.className = "piece";
      piece.style.position = "absolute";
      Object.assign(piece.style, {
        left: slot.style.left,
        top: slot.style.top,
        width: slot.style.width,
        height: slot.style.height,
        objectFit: "contain",
        pointerEvents: "none"
      });
      board.appendChild(piece);
      slot.classList.add("correct");
      img.style.visibility = "hidden";
      checkWin();
    }

    function checkWin(){
      const filled = slots.filter(s=>s.dataset.filled).length;
      if(filled === PIECES.length){
        setTimeout(()=>alert("üéâ Ch√∫c m·ª´ng, b·∫°n ƒë√£ ho√†n th√†nh h√¨nh tr√°i tim! üíñ"),200);
      }
    }

    // N√∫t ch·ª©c nƒÉng
    document.getElementById("shuffle").onclick = () => {
      const arr = [...tray.children];
      arr.sort(()=>Math.random()-0.5).forEach(c=>tray.appendChild(c));
    };
    document.getElementById("reset").onclick = () => {
      tray.querySelectorAll("img").forEach(img=>img.style.visibility="visible");
      board.querySelectorAll(".piece").forEach(p=>p.remove());
      slots.forEach(s=>{s.classList.remove("correct"); delete s.dataset.filled;});
    };
    let show = true;
    document.getElementById("toggle").onclick = () => {
      show = !show;
      board.style.opacity = show ? 1 : 0.1;
    };

    // Kh·ªüi t·∫°o
    createPieces();
  </script>
</body>
</html>
